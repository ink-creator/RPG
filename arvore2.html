<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Árvore de Habilidades</title>

<style>
body{
  margin:0;
  background:#050509;
  font-family:Arial,sans-serif;
  overflow:hidden;
}

#toolbar{
  position:fixed;
  top:10px;
  left:10px;
  z-index:10;
}

#toolbar button{
  padding:10px 14px;
  background:#6a5acd;
  border:none;
  color:white;
  font-weight:bold;
  border-radius:8px;
  cursor:pointer;
}

#canvas{
  width:100vw;
  height:100vh;
  position:relative;
}

svg{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  pointer-events:none;
}

.node{
  position:absolute;
  display:flex;
  flex-direction:column;
  align-items:center;
  cursor:grab;
  user-select:none;
}

.bubble{
  width:90px;
  height:90px;
  border-radius:50%;
  background:#222;
  border:2px solid #aaa;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
}

.bubble img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.node-title{
  margin-top:6px;
  font-size:12px;
  color:white;
  text-align:center;
}
</style>
</head>

<body>

<div id="toolbar">
  <button onclick="addBubble()">➕ Bolha</button>
</div>

<div id="canvas">
  <svg id="lines"></svg>
</div>

<script type="module">
/* ============================
   FIREBASE
============================ */
import { db, ref, set, onValue } from "./firebase.js";

/* ============================
   PLAYER
============================ */
const params = new URLSearchParams(window.location.search);
const PLAYER_ID = params.get("player");

if(!PLAYER_ID){
  alert("Player não identificado!");
  throw new Error("PLAYER_ID ausente");
}

const DB_REF = ref(db, `skilltrees/${PLAYER_ID}`);

/* ============================
   VARIÁVEIS
============================ */
let nodes=[];
let connections=[];
let loading=false;

const canvas=document.getElementById("canvas");
const svg=document.getElementById("lines");

/* ============================
   CRIAR BOLHA
============================ */
function addBubble(data={}){
  const node=document.createElement("div");
  node.className="node";
  node.style.left=data.left ?? "200px";
  node.style.top=data.top ?? "200px";

  const bubble=document.createElement("div");
  bubble.className="bubble";

  const title=document.createElement("div");
  title.className="node-title";
  title.textContent=data.title ?? "";

  node.dataset.title=data.title ?? "";

  node.appendChild(bubble);
  node.appendChild(title);

  drag(node);
  canvas.appendChild(node);
  nodes.push(node);

  if(!loading) saveAll();
}

/* ============================
   DRAG
============================ */
function drag(el){
  let ox,oy;
  el.onmousedown=e=>{
    ox=e.offsetX;
    oy=e.offsetY;

    document.onmousemove=ev=>{
      el.style.left=(ev.pageX-ox)+"px";
      el.style.top=(ev.pageY-oy)+"px";
      drawLines();
    };

    document.onmouseup=()=>{
      document.onmousemove=null;
      saveAll();
    };
  };
}

/* ============================
   CONEXÕES
============================ */
function drawLines(){
  svg.innerHTML="";
  connections.forEach(([a,b])=>{
    const ax=parseInt(a.style.left)+45;
    const ay=parseInt(a.style.top)+45;
    const bx=parseInt(b.style.left)+45;
    const by=parseInt(b.style.top)+45;

    const l=document.createElementNS("http://www.w3.org/2000/svg","line");
    l.setAttribute("x1",ax);
    l.setAttribute("y1",ay);
    l.setAttribute("x2",bx);
    l.setAttribute("y2",by);
    l.setAttribute("stroke","#aaa");
    l.setAttribute("stroke-width","2");
    svg.appendChild(l);
  });
}

/* ============================
   SAVE FIREBASE
============================ */
function saveAll(){
  if(loading) return;

  set(DB_REF,{
    nodes:nodes.map(n=>({
      left:n.style.left,
      top:n.style.top,
      title:n.dataset.title
    })),
    connections:connections.map(c=>[
      nodes.indexOf(c[0]),
      nodes.indexOf(c[1])
    ])
  });
}

/* ============================
   LOAD FIREBASE
============================ */
onValue(DB_REF,snapshot=>{
  if(!snapshot.exists()) return;

  loading=true;
  const data=snapshot.val();

  nodes=[];
  connections=[];
  canvas.querySelectorAll(".node").forEach(n=>n.remove());

  data.nodes.forEach(n=>addBubble(n));
  data.connections.forEach(([i,j])=>{
    if(nodes[i] && nodes[j])
      connections.push([nodes[i],nodes[j]]);
  });

  drawLines();
  loading=false;
});
</script>

</body>
</html>
