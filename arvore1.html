<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>√Årvore de Habilidades</title>

<style>
body{
  margin:0;
  background:#0b0b12;
  font-family:Arial,sans-serif;
  height:auto;
  overflow-y:auto;
}
#toolbar{position:fixed;top:10px;left:10px;z-index:10;}
#toolbar button{
  padding:10px 14px;
  background:#6a5acd;
  border:none;
  color:white;
  font-weight:bold;
  border-radius:8px;
  cursor:pointer;
}
#canvas{width:100vw;height:100vh;position:relative;}
svg{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;}

.node{
  position:absolute;
  display:flex;
  flex-direction:column;
  align-items:center;
  cursor:grab;
  transform-origin:center;
}
.bubble{
  width:90px;height:90px;border-radius:50%;
  background:#222;border:2px solid #aaa;
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
}
.bubble img{width:100%;height:100%;object-fit:cover;}
.node-title{margin-top:6px;font-size:12px;color:white;text-align:center;}

#panel{
  position:fixed;right:20px;top:20px;width:260px;
  background:#151520;border-radius:12px;padding:14px;color:white;
}
#panel input,#panel textarea{
  width:100%;background:#0f0f18;color:white;
  border:1px solid #444;border-radius:6px;padding:6px;margin-bottom:8px;
}
.panel-btn{
  width:100%;
  padding:8px;
  margin-top:6px;
  background:#6a5acd;
  border:none;
  color:white;
  border-radius:6px;
  cursor:pointer;
}
.warn{background:#e67e22;}
.danger{background:#c0392b;}
</style>
</head>

<body data-tree="p1">

<div id="toolbar">
  <button id="btnAdd">‚ûï Adicionar Bolha</button>
</div>

<div id="canvas">
  <svg id="lines"></svg>
</div>

<div id="panel" hidden>
  <input id="titleInput" placeholder="Nome">
  <textarea id="descInput" placeholder="Descri√ß√£o"></textarea>
  <input id="fileInput" type="file" accept="image/*">

  <!-- CONTROLE DE TAMANHO -->
  <input id="sizeInput" type="range" min="0.5" max="2" step="0.05">

  <button class="panel-btn" id="btnConnect">üîó Conectar pr√≥xima</button>
  <button class="panel-btn warn" id="btnClear">‚ùå Remover liga√ß√µes</button>
  <button class="panel-btn danger" id="btnDelete">üóëÔ∏è Excluir bolha</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* =========================
   FIREBASE
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyBCCbxXH6UZEqpItsdVaaG354Nqu28HA44",
  authDomain: "rpg-ficha-online.firebaseapp.com",
  databaseURL: "https://rpg-ficha-online-default-rtdb.firebaseio.com",
  projectId: "rpg-ficha-online",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const TREE_ID = document.body.dataset.tree || "default";
const treeRef = ref(db, `skillTrees/${TREE_ID}`);

/* =========================
   ESTADO
========================= */
const canvas = document.getElementById("canvas");
const svg = document.getElementById("lines");
const panel = document.getElementById("panel");

const btnAdd = document.getElementById("btnAdd");
const btnConnect = document.getElementById("btnConnect");
const btnClear = document.getElementById("btnClear");
const btnDelete = document.getElementById("btnDelete");

const titleInput = document.getElementById("titleInput");
const descInput  = document.getElementById("descInput");
const fileInput  = document.getElementById("fileInput");
const sizeInput  = document.getElementById("sizeInput");

let nodes = [];
let connections = [];
let selected = null;

let loading = true;
let initialized = false;
let isEditing = false;

/* =========================
   FIX: painel n√£o fecha
========================= */
panel.addEventListener("click", e => e.stopPropagation());

document.addEventListener("click", () => {
  selected = null;
  panel.hidden = true;
});

/* =========================
   CREATE
========================= */
function addBubble(data = {}, silent = false) {
  const node = document.createElement("div");
  node.className = "node";
  node.style.left = data.left || "200px";
  node.style.top  = data.top  || "200px";

  node.dataset.title = data.title || "";
  node.dataset.desc  = data.desc  || "";
  node.dataset.img   = data.img   || "";
  node.dataset.size  = data.size  || "1";

  node.style.transform = `scale(${node.dataset.size})`;

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  if (node.dataset.img) {
    const img = document.createElement("img");
    img.src = node.dataset.img;
    bubble.appendChild(img);
  }

  const title = document.createElement("div");
  title.className = "node-title";
  title.textContent = node.dataset.title;

  node.append(bubble, title);

  node.onclick = e => {
    e.stopPropagation();
    selectNode(node);
  };

  drag(node);
  canvas.appendChild(node);
  nodes.push(node);

  if (!silent && initialized) saveAll();
}

/* =========================
   SELECT
========================= */
function selectNode(node) {
  selected = node;
  panel.hidden = false;
  titleInput.value = node.dataset.title;
  descInput.value  = node.dataset.desc;
  sizeInput.value  = node.dataset.size || 1;
}

/* =========================
   DRAG
========================= */
function drag(el) {
  let ox, oy;

  el.onmousedown = e => {
    ox = e.offsetX;
    oy = e.offsetY;

    document.onmousemove = ev => {
      el.style.left = (ev.pageX - ox) + "px";
      el.style.top  = (ev.pageY - oy) + "px";
      drawLines();
    };

    document.onmouseup = () => {
      document.onmousemove = null;
      saveAll();
    };
  };
}

/* =========================
   LINES
========================= */
function connectNearest() {
  if (!selected || nodes.length < 2) return;

  let min = Infinity;
  let target = null;

  nodes.forEach(n => {
    if (n === selected) return;
    const dx = parseInt(n.style.left) - parseInt(selected.style.left);
    const dy = parseInt(n.style.top)  - parseInt(selected.style.top);
    const d = Math.hypot(dx, dy);
    if (d < min) {
      min = d;
      target = n;
    }
  });

  if (target) {
    connections.push([selected, target]);
    drawLines();
    saveAll();
  }
}

function drawLines() {
  svg.innerHTML = "";
  connections.forEach(([a, b]) => {
    const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
    l.setAttribute("x1", parseInt(a.style.left) + 45);
    l.setAttribute("y1", parseInt(a.style.top)  + 45);
    l.setAttribute("x2", parseInt(b.style.left) + 45);
    l.setAttribute("y2", parseInt(b.style.top)  + 45);
    l.setAttribute("stroke", "#aaa");
    l.setAttribute("stroke-width", "2");
    svg.appendChild(l);
  });
}

/* =========================
   PANEL INPUTS
========================= */
titleInput.oninput = () => {
  if (!selected) return;
  isEditing = true;
  selected.dataset.title = titleInput.value;
  selected.querySelector(".node-title").textContent = titleInput.value;
  saveAll();
  isEditing = false;
};

descInput.oninput = () => {
  if (!selected) return;
  isEditing = true;
  selected.dataset.desc = descInput.value;
  saveAll();
  isEditing = false;
};

sizeInput.oninput = () => {
  if (!selected) return;
  isEditing = true;
  selected.dataset.size = sizeInput.value;
  selected.style.transform = `scale(${sizeInput.value})`;
  drawLines();
  saveAll();
  isEditing = false;
};

fileInput.onchange = () => {
  if (!selected || !fileInput.files[0]) return;
  isEditing = true;

  const r = new FileReader();
  r.onload = e => {
    selected.dataset.img = e.target.result;
    const b = selected.querySelector(".bubble");
    b.innerHTML = "";
    const img = document.createElement("img");
    img.src = e.target.result;
    b.appendChild(img);
    saveAll();
    isEditing = false;
  };
  r.readAsDataURL(fileInput.files[0]);
};

/* =========================
   DELETE / CLEAR
========================= */
btnDelete.onclick = () => {
  if (!selected) return;
  connections = connections.filter(c => c[0] !== selected && c[1] !== selected);
  nodes = nodes.filter(n => n !== selected);
  selected.remove();
  selected = null;
  panel.hidden = true;
  drawLines();
  saveAll();
};

btnClear.onclick = () => {
  if (!selected) return;
  connections = connections.filter(c => c[0] !== selected && c[1] !== selected);
  drawLines();
  saveAll();
};

btnConnect.onclick = connectNearest;
btnAdd.onclick = () => addBubble();

/* =========================
   FIREBASE SAVE / LOAD
========================= */
function saveAll() {
  if (loading || !initialized) return;

  set(treeRef, {
    nodes: nodes.map(n => ({
      left: n.style.left,
      top: n.style.top,
      title: n.dataset.title,
      desc: n.dataset.desc,
      img: n.dataset.img,
      size: n.dataset.size
    })),
    connections: connections.map(c => [
      nodes.indexOf(c[0]),
      nodes.indexOf(c[1])
    ])
  });
}

onValue(treeRef, snapshot => {
  if (isEditing) return;

  loading = true;

  nodes.forEach(n => n.remove());
  nodes = [];
  connections = [];

  if (snapshot.exists()) {
    const data = snapshot.val();
    data.nodes?.forEach(n => addBubble(n, true));
    data.connections?.forEach(([i, j]) => {
      if (nodes[i] && nodes[j]) connections.push([nodes[i], nodes[j]]);
    });
  }

  drawLines();
  loading = false;
  initialized = true;
});
</script>

</body>
</html>
