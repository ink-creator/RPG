<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>√Årvore de Habilidades</title>

<style>
body{
  margin:0;
  background:radial-gradient(circle at center,#0e0e14,#050509);
  font-family:Arial,sans-serif;
  overflow:hidden;
}

#toolbar{
  position:fixed;
  top:10px;
  left:10px;
  z-index:10;
}

#toolbar button{
  padding:10px 14px;
  background:#6a5acd;
  border:none;
  color:white;
  font-weight:bold;
  border-radius:8px;
  cursor:pointer;
}

#playerTitle{
  position:fixed;
  top:10px;
  right:20px;
  color:white;
  font-weight:bold;
  opacity:.85;
}

#canvas{
  width:100vw;
  height:100vh;
  position:relative;
}

svg{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  pointer-events:none;
}

.node{
  position:absolute;
  display:flex;
  flex-direction:column;
  align-items:center;
  cursor:grab;
  user-select:none;
}

.bubble{
  width:90px;
  height:90px;
  border-radius:50%;
  background:#222;
  border:2px solid #aaa;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
}

.bubble img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.node-title{
  margin-top:6px;
  font-size:12px;
  color:white;
  text-align:center;
  max-width:120px;
}

#panel{
  position:fixed;
  right:20px;
  top:50px;
  width:260px;
  background:#151520;
  border-radius:12px;
  padding:14px;
  color:white;
  box-shadow:0 0 25px rgba(0,0,0,.6);
  z-index:20;
}

#panel input,
#panel textarea{
  width:100%;
  background:#0f0f18;
  color:white;
  border:1px solid #444;
  border-radius:6px;
  padding:6px;
  margin-bottom:8px;
}

.panel-btn{
  width:100%;
  padding:8px;
  margin-top:6px;
  background:#6a5acd;
  border:none;
  color:white;
  border-radius:6px;
  cursor:pointer;
}

.panel-btn.warn{ background:#e67e22; }
.panel-btn.danger{ background:#c0392b; }
</style>
</head>

<body>

<div id="toolbar">
  <button onclick="addBubble()">‚ûï Adicionar Bolha</button>
</div>

<div id="playerTitle"></div>

<div id="canvas">
  <svg id="lines"></svg>
</div>

<div id="panel" hidden>
  <input id="titleInput" placeholder="Nome">
  <textarea id="descInput" placeholder="Descri√ß√£o"></textarea>
  <input id="fileInput" type="file" accept="image/*">
  <input id="sizeInput" type="range" min="60" max="160">

  <button class="panel-btn" onclick="connectNearest()">üîó Conectar pr√≥xima</button>
  <button class="panel-btn warn" onclick="cancelConnections()">‚ùå Cancelar liga√ß√µes</button>
  <button class="panel-btn danger" onclick="deleteBubble()">üóëÔ∏è Excluir</button>
</div>

<script type="module">
/* ===============================
   FIREBASE
================================ */
import { db, ref, set, onValue } from "./firebase.js";

/* ===============================
   PLAYER
================================ */
const params = new URLSearchParams(window.location.search);
const PLAYER_ID = params.get("player") ?? "p1";

document.getElementById("playerTitle").textContent =
  `√Årvore de Habilidades ‚Äî ${PLAYER_ID}`;

/* ===============================
   VARI√ÅVEIS
================================ */
let nodes=[];
let connections=[];
let selected=null;
let loading=true;

const canvas=document.getElementById("canvas");
const svg=document.getElementById("lines");
const panel=document.getElementById("panel");

const titleInput=document.getElementById("titleInput");
const descInput=document.getElementById("descInput");
const fileInput=document.getElementById("fileInput");
const sizeInput=document.getElementById("sizeInput");

const treeRef = ref(db, `skillTrees/${PLAYER_ID}`);

/* ===============================
   FIREBASE LOAD
================================ */
onValue(treeRef, snap => {
  if (!snap.exists()) {
    loading = false;
    return;
  }

  loading = true;
  const data = snap.val();

  nodes=[];
  connections=[];
  canvas.querySelectorAll(".node").forEach(n=>n.remove());

  data.nodes?.forEach(n => addBubble(n, false));
  data.connections?.forEach(([i,j]) => {
    if(nodes[i] && nodes[j]) connections.push([nodes[i],nodes[j]]);
  });

  drawLines();
  loading = false;
});

/* ===============================
   SAVE
================================ */
function saveAll(){
  if(loading) return;

  set(treeRef, {
    nodes: nodes.map(n=>({
      left:n.style.left,
      top:n.style.top,
      title:n.dataset.title,
      desc:n.dataset.desc,
      size:n.dataset.size,
      img:n.dataset.img
    })),
    connections: connections.map(c=>[
      nodes.indexOf(c[0]),
      nodes.indexOf(c[1])
    ])
  });
}

/* ===============================
   CREATE
================================ */
function addBubble(data={}, save=true){
  const node=document.createElement("div");
  node.className="node";
  node.style.left=data.left ?? "200px";
  node.style.top=data.top ?? "200px";

  const bubble=document.createElement("div");
  bubble.className="bubble";
  bubble.style.width=bubble.style.height=(data.size ?? 90)+"px";

  if(data.img){
    const img=document.createElement("img");
    img.src=data.img;
    bubble.appendChild(img);
  }

  const title=document.createElement("div");
  title.className="node-title";
  title.textContent=data.title ?? "";

  node.dataset.title=data.title ?? "";
  node.dataset.desc=data.desc ?? "";
  node.dataset.size=data.size ?? 90;
  node.dataset.img=data.img ?? "";

  node.appendChild(bubble);
  node.appendChild(title);

  node.onclick=e=>{
    e.stopPropagation();
    selectNode(node);
  };

  drag(node);
  canvas.appendChild(node);
  nodes.push(node);

  if(save) saveAll();
}

/* ===============================
   INTERA√á√ïES
================================ */
function selectNode(node){
  selected=node;
  panel.hidden=false;
  titleInput.value=node.dataset.title;
  descInput.value=node.dataset.desc;
  sizeInput.value=node.dataset.size;
}

function drag(el){
  let ox,oy;
  el.onmousedown=e=>{
    ox=e.offsetX; oy=e.offsetY;
    document.onmousemove=ev=>{
      el.style.left=(ev.pageX-ox)+"px";
      el.style.top=(ev.pageY-oy)+"px";
      drawLines();
    };
    document.onmouseup=()=>{
      document.onmousemove=null;
      saveAll();
    };
  };
}

function connectNearest(){
  if(!selected) return;
  let min=Infinity, target=null;
  nodes.forEach(n=>{
    if(n===selected) return;
    const d=Math.hypot(
      parseInt(n.style.left)-parseInt(selected.style.left),
      parseInt(n.style.top)-parseInt(selected.style.top)
    );
    if(d<min){ min=d; target=n; }
  });
  if(target){
    connections.push([selected,target]);
    drawLines();
    saveAll();
  }
}

function cancelConnections(){
  if(!selected) return;
  connections=connections.filter(c=>!c.includes(selected));
  drawLines();
  saveAll();
}

function drawLines(){
  svg.innerHTML="";
  connections.forEach(([a,b])=>{
    const l=document.createElementNS("http://www.w3.org/2000/svg","line");
    l.setAttribute("x1",parseInt(a.style.left)+45);
    l.setAttribute("y1",parseInt(a.style.top)+45);
    l.setAttribute("x2",parseInt(b.style.left)+45);
    l.setAttribute("y2",parseInt(b.style.top)+45);
    l.setAttribute("stroke","#aaa");
    l.setAttribute("stroke-width","2");
    svg.appendChild(l);
  });
}

function deleteBubble(){
  if(!selected) return;
  connections=connections.filter(c=>!c.includes(selected));
  nodes=nodes.filter(n=>n!==selected);
  selected.remove();
  selected=null;
  panel.hidden=true;
  drawLines();
  saveAll();
}

titleInput.oninput=()=>{ if(selected){ selected.dataset.title=titleInput.value; selected.querySelector(".node-title").textContent=titleInput.value; saveAll(); }};
descInput.oninput=()=>{ if(selected){ selected.dataset.desc=descInput.value; saveAll(); }};
sizeInput.oninput=()=>{ if(selected){ selected.dataset.size=sizeInput.value; selected.querySelector(".bubble").style.width=selected.querySelector(".bubble").style.height=sizeInput.value+"px"; drawLines(); saveAll(); }};

fileInput.onchange=()=>{
  if(!selected || !fileInput.files[0]) return;
  const r=new FileReader();
  r.onload=e=>{
    selected.dataset.img=e.target.result;
    const b=selected.querySelector(".bubble");
    b.innerHTML="";
    const i=document.createElement("img");
    i.src=e.target.result;
    b.appendChild(i);
    saveAll();
  };
  r.readAsDataURL(fileInput.files[0]);
};

document.addEventListener("click",()=>{ panel.hidden=true; selected=null; });
</script>

</body>
</html>
