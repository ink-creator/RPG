<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Árvore de Habilidades</title>

<style>
body{
  margin:0;
  background:#0e0e14;
  font-family:Arial,sans-serif;
  overflow:hidden;
}

#toolbar{
  position:fixed;
  top:10px;
  left:10px;
  z-index:10;
}

#toolbar button{
  padding:10px 14px;
  background:#6a5acd;
  border:none;
  color:white;
  font-weight:bold;
  border-radius:8px;
  cursor:pointer;
}

#canvas{
  width:100vw;
  height:100vh;
  position:relative;
}

svg{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  pointer-events:none;
}

.node{
  position:absolute;
  display:flex;
  flex-direction:column;
  align-items:center;
  cursor:grab;
  user-select:none;
}

.bubble{
  width:90px;
  height:90px;
  border-radius:50%;
  background:#222;
  border:2px solid #aaa;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
}

.node-title{
  margin-top:6px;
  font-size:12px;
  color:white;
  text-align:center;
}
</style>
</head>

<body>

<div id="toolbar">
  <button id="btnAdd">➕ Adicionar Bolha</button>
</div>

<div id="canvas">
  <svg id="lines"></svg>
</div>

<script type="module">
/* ===========================
   FIREBASE
=========================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_DOMINIO",
  databaseURL: "SUA_DATABASE_URL",
  projectId: "SEU_PROJECT_ID",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const treeRef = ref(db, "skillTree");

/* ===========================
   ESTADO
=========================== */
let nodes = [];
let connections = [];
let loading = true;

const canvas = document.getElementById("canvas");
const svg = document.getElementById("lines");

/* ===========================
   CRIAR BOLHA
=========================== */
function addBubble(data = {}) {
  const node = document.createElement("div");
  node.className = "node";
  node.style.left = data.left ?? "200px";
  node.style.top = data.top ?? "200px";

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = data.title ?? "Skill";

  const title = document.createElement("div");
  title.className = "node-title";
  title.textContent = data.title ?? "Skill";

  node.dataset.title = data.title ?? "Skill";

  node.appendChild(bubble);
  node.appendChild(title);
  canvas.appendChild(node);
  nodes.push(node);

  drag(node);

  if (!loading) saveAll();
}

/* ===========================
   DRAG
=========================== */
function drag(el){
  let ox, oy;
  el.onmousedown = e => {
    ox = e.offsetX;
    oy = e.offsetY;

    document.onmousemove = ev => {
      el.style.left = (ev.pageX - ox) + "px";
      el.style.top  = (ev.pageY - oy) + "px";
      drawLines();
    };

    document.onmouseup = () => {
      document.onmousemove = null;
      saveAll();
    };
  };
}

/* ===========================
   LINHAS (FUTURO)
=========================== */
function drawLines(){
  svg.innerHTML = "";
}

/* ===========================
   SALVAR NO FIREBASE
=========================== */
function saveAll(){
  const data = {
    nodes: nodes.map(n => ({
      left: n.style.left,
      top: n.style.top,
      title: n.dataset.title
    })),
    connections: []
  };

  set(treeRef, data);
}

/* ===========================
   CARREGAR DO FIREBASE
=========================== */
onValue(treeRef, snapshot => {
  if (!snapshot.exists()) {
    loading = false;
    return;
  }

  loading = true;
  const data = snapshot.val();

  nodes.forEach(n => n.remove());
  nodes = [];

  data.nodes.forEach(n => addBubble(n));

  drawLines();
  loading = false;
});

/* ===========================
   BOTÃO
=========================== */
document.getElementById("btnAdd").addEventListener("click", () => {
  addBubble();
});
</script>

</body>
</html>
