<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>√Årvore de Habilidades</title>

<style>
body{margin:0;background:#0b0b12;font-family:Arial,sans-serif;}
#toolbar{position:fixed;top:10px;left:10px;z-index:10;}
#toolbar button{padding:10px 14px;background:#6a5acd;border:none;color:#fff;border-radius:8px;cursor:pointer;}
#canvas{width:100vw;height:100vh;position:relative;}
svg{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;}

.node{position:absolute;display:flex;flex-direction:column;align-items:center;cursor:grab;transform-origin:center;}
.bubble{width:90px;height:90px;border-radius:50%;background:#222;border:2px solid #aaa;overflow:hidden;}
.bubble img{width:100%;height:100%;object-fit:cover;}
.node-title{margin-top:6px;font-size:12px;color:#fff;}

#panel{position:fixed;right:20px;top:20px;width:260px;background:#151520;border-radius:12px;padding:14px;color:#fff;}
#panel input,#panel textarea{width:100%;background:#0f0f18;color:#fff;border:1px solid #444;border-radius:6px;padding:6px;margin-bottom:8px;}
.panel-btn{width:100%;padding:8px;margin-top:6px;background:#6a5acd;border:none;color:#fff;border-radius:6px;cursor:pointer;}
.warn{background:#e67e22;}
.danger{background:#c0392b;}
</style>
</head>

<body data-tree="p5">

<div id="toolbar">
  <button id="btnAdd">‚ûï Adicionar Bolha</button>
</div>

<div id="canvas"><svg id="lines"></svg></div>

<div id="panel" hidden>
  <input id="titleInput" placeholder="Nome">
  <textarea id="descInput" placeholder="Descri√ß√£o"></textarea>
  <input id="fileInput" type="file">
  <input id="sizeInput" type="range" min="0.5" max="2" step="0.05">
  <button class="panel-btn" id="btnConnect">üîó Conectar pr√≥xima</button>
  <button class="panel-btn warn" id="btnClear">‚ùå Remover liga√ß√µes</button>
  <button class="panel-btn danger" id="btnDelete">üóëÔ∏è Excluir bolha</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

/* FIREBASE */
const app = initializeApp({
  apiKey: "AIzaSyBCCbxXH6UZEqpItsdVaaG354Nqu28HA44",
  databaseURL: "https://rpg-ficha-online-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);
const treeRef = ref(db, `skillTrees/${document.body.dataset.tree}`);

/* ESTADO */
const canvas = document.getElementById("canvas");
const svg = document.getElementById("lines");
const panel = document.getElementById("panel");

let nodes = [];
let connections = [];
let selected = null;
let selectedIndex = null;

let loading = true;
let initialized = false;
let isEditing = false;

/* CLICK FORA */
document.addEventListener("mousedown", e => {
  if (e.target.closest(".node") || e.target.closest("#panel") || e.target.closest("#toolbar")) return;
  selected = null;
  selectedIndex = null;
  panel.hidden = true;
});

/* CREATE */
function addBubble(data={}, silent=false){
  const node=document.createElement("div");
  node.className="node";
  node.style.left=data.left||"200px";
  node.style.top=data.top||"200px";
  node.dataset.size=data.size||1;
  node.style.transform=`scale(${node.dataset.size})`;

  const bubble=document.createElement("div");
  bubble.className="bubble";
  if(data.img){const img=document.createElement("img");img.src=data.img;bubble.appendChild(img);}

  const title=document.createElement("div");
  title.className="node-title";
  title.textContent=data.title||"";

  node.append(bubble,title);
  node.onclick=e=>{e.stopPropagation();selectNode(node);};
  drag(node);

  canvas.appendChild(node);
  nodes.push(node);

  if(!silent && initialized) saveAll();
}

/* SELECT */
function selectNode(node){
  selected=node;
  selectedIndex=nodes.indexOf(node);
  panel.hidden=false;
  titleInput.value=node.querySelector(".node-title").textContent;
  sizeInput.value=node.dataset.size;
}

/* DRAG */
function drag(el){
  let ox,oy;
  el.onmousedown=e=>{
    ox=e.offsetX; oy=e.offsetY;
    document.onmousemove=ev=>{
      el.style.left=ev.pageX-ox+"px";
      el.style.top=ev.pageY-oy+"px";
      drawLines();
    };
    document.onmouseup=()=>{document.onmousemove=null;saveAll();};
  };
}

/* LINES */
function connectNearest(){
  if(!selected) return;
  let min=Infinity,target=null;
  nodes.forEach(n=>{
    if(n===selected) return;
    const d=Math.hypot(
      parseInt(n.style.left)-parseInt(selected.style.left),
      parseInt(n.style.top)-parseInt(selected.style.top)
    );
    if(d<min){min=d;target=n;}
  });
  if(target){connections.push([selected,target]);drawLines();saveAll();}
}

function drawLines(){
  svg.innerHTML="";
  connections.forEach(([a,b])=>{
    const l=document.createElementNS("http://www.w3.org/2000/svg","line");
    l.setAttribute("x1",parseInt(a.style.left)+45);
    l.setAttribute("y1",parseInt(a.style.top)+45);
    l.setAttribute("x2",parseInt(b.style.left)+45);
    l.setAttribute("y2",parseInt(b.style.top)+45);
    l.setAttribute("stroke","#aaa");
    l.setAttribute("stroke-width","2");
    svg.appendChild(l);
  });
}

/* PANEL */
sizeInput.oninput=()=>{
  if(!selected) return;
  isEditing=true;
  selected.dataset.size=sizeInput.value;
  selected.style.transform=`scale(${sizeInput.value})`;
  drawLines();
  saveAll();
  isEditing=false;
};

btnConnect.onclick=connectNearest;

/* SAVE / LOAD */
function saveAll(){
  if(loading||!initialized) return;
  set(treeRef,{
    nodes:nodes.map(n=>({
      left:n.style.left,
      top:n.style.top,
      size:n.dataset.size,
      title:n.querySelector(".node-title").textContent
    })),
    connections:connections.map(c=>[nodes.indexOf(c[0]),nodes.indexOf(c[1])])
  });
}

onValue(treeRef,snap=>{
  if(isEditing) return;
  loading=true;

  nodes.forEach(n=>n.remove());
  nodes=[]; connections=[];

  if(snap.exists()){
    const d=snap.val();
    d.nodes?.forEach(n=>addBubble(n,true));
    d.connections?.forEach(([i,j])=>{
      if(nodes[i]&&nodes[j]) connections.push([nodes[i],nodes[j]]);
    });
  }

  if(selectedIndex!==null && nodes[selectedIndex]){
    selectNode(nodes[selectedIndex]);
  }

  drawLines();
  loading=false;
  initialized=true;
});
</script>
</body>
</html>
