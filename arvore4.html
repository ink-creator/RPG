<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>√Årvore de Habilidades</title>

<style>
body{
  margin:0;
  background:#0b0b12;
  font-family:Arial,sans-serif;
  overflow:auto;
}
#toolbar{
  position:fixed;
  top:10px;
  left:10px;
  z-index:10;
}
#toolbar button{
  padding:10px 14px;
  background:#6a5acd;
  border:none;
  color:#fff;
  border-radius:8px;
  cursor:pointer;
}
#canvas{
  position:relative;
  min-width:100vw;
  min-height:100vh;
}
svg{
  position:absolute;
  top:0;
  left:0;
  pointer-events:none;
}
.node{
  position:absolute;
  display:flex;
  flex-direction:column;
  align-items:center;
  cursor:grab;
}
.node.selected .bubble{
  border-color:#6a5acd;
  box-shadow:0 0 10px #6a5acd;
}
.bubble{
  width:90px;
  height:90px;
  border-radius:50%;
  background:#222;
  border:2px solid #aaa;
  overflow:hidden;
}
.bubble img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.node-title{
  margin-top:6px;
  font-size:12px;
  color:#fff;
  text-align:center;
}
#panel{
  position:fixed;
  right:20px;
  top:20px;
  width:260px;
  background:#151520;
  border-radius:12px;
  padding:14px;
  color:#fff;
  z-index:20;
}
#panel input,
#panel textarea{
  width:100%;
  background:#0f0f18;
  color:#fff;
  border:1px solid #444;
  border-radius:6px;
  padding:6px;
  margin-bottom:8px;
}
.panel-btn{
  width:100%;
  padding:8px;
  margin-top:6px;
  background:#6a5acd;
  border:none;
  color:#fff;
  border-radius:6px;
  cursor:pointer;
}
.warn{background:#e67e22;}
.danger{background:#c0392b;}
</style>
</head>

<body data-tree="p4">

<div id="toolbar">
  <button id="btnAdd">‚ûï Adicionar Bolha</button>
</div>

<div id="canvas">
  <svg id="lines"></svg>
</div>

<div id="panel" hidden>
  <input id="titleInput" placeholder="Nome">
  <textarea id="descInput" placeholder="Descri√ß√£o"></textarea>
  <input id="fileInput" type="file" accept="image/*">
  <input id="sizeInput" type="range" min="0.5" max="2" step="0.05">
  <button class="panel-btn" id="btnConnect">üîó Conectar pr√≥xima</button>
  <button class="panel-btn warn" id="btnClear">‚ùå Remover liga√ß√µes</button>
  <button class="panel-btn danger" id="btnDelete">üóëÔ∏è Excluir bolha</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* ======================
   SUPABASE
====================== */
const supabase = createClient(
  "https://zhfqewgnnfejfyfkmyae.supabase.co",
  "sb_publishable_DGpfjOL9IQ4t8DEiz06fhQ_YDnJABI6"
);

/* ======================
   DOM
====================== */
const canvas = document.getElementById("canvas");
const svg = document.getElementById("lines");
const panel = document.getElementById("panel");

const titleInput = document.getElementById("titleInput");
const descInput  = document.getElementById("descInput");
const fileInput  = document.getElementById("fileInput");
const sizeInput  = document.getElementById("sizeInput");

const btnAdd     = document.getElementById("btnAdd");
const btnConnect = document.getElementById("btnConnect");
const btnClear   = document.getElementById("btnClear");
const btnDelete  = document.getElementById("btnDelete");

/* ======================
   ESTADO
====================== */
let nodes = [];
let connections = [];
let selected = null;
let saveTimer = null;

/* ======================
   UTIL
====================== */
function updateCanvasSize(){
  let maxX = window.innerWidth;
  let maxY = window.innerHeight;

  nodes.forEach(n=>{
    maxX = Math.max(maxX, parseInt(n.style.left) + 300);
    maxY = Math.max(maxY, parseInt(n.style.top) + 300);
  });

  canvas.style.width = maxX+"px";
  canvas.style.height = maxY+"px";
  svg.setAttribute("width", maxX);
  svg.setAttribute("height", maxY);
}

/* ======================
   CREATE
====================== */
function addBubble(data={}, silent=false){
  const node = document.createElement("div");
  node.className = "node";
  node.dataset.id = data.id || crypto.randomUUID();

  node.style.left = data.left || "200px";
  node.style.top  = data.top  || "200px";
  node.dataset.title = data.title || "";
  node.dataset.desc  = data.desc  || "";
  node.dataset.img   = data.img   || "";
  node.dataset.size  = data.size  || "1";

  node.style.transform = `scale(${node.dataset.size})`;

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  if(node.dataset.img){
    const img = document.createElement("img");
    img.src = node.dataset.img;
    bubble.appendChild(img);
  }

  const title = document.createElement("div");
  title.className = "node-title";
  title.textContent = node.dataset.title;

  node.append(bubble, title);
  drag(node);

  canvas.appendChild(node);
  nodes.push(node);

  updateCanvasSize();
  if(!silent) saveAll();
}

/* ======================
   SELECT
====================== */
function selectNode(node){
  nodes.forEach(n=>n.classList.remove("selected"));
  selected = node;
  node.classList.add("selected");
  panel.hidden = false;
  titleInput.value = node.dataset.title;
  descInput.value  = node.dataset.desc;
  sizeInput.value  = node.dataset.size;
}

/* ======================
   DRAG + CLICK
====================== */
function drag(el){
  let ox, oy, moved = false;

  el.onmousedown = e => {
    moved = false;
    ox = e.offsetX;
    oy = e.offsetY;

    document.onmousemove = ev => {
      moved = true;
      el.style.left = ev.pageX - ox + "px";
      el.style.top  = ev.pageY - oy + "px";
      drawLines();
    };

    document.onmouseup = () => {
      document.onmousemove = null;
      if(moved){
        saveAll();
      }else{
        selectNode(el);
      }
    };
  };
}

/* ======================
   CONNECTIONS
====================== */
function drawLines(){
  svg.innerHTML = "";
  connections.forEach(([a,b])=>{
    const l = document.createElementNS("http://www.w3.org/2000/svg","line");
    l.setAttribute("x1", parseInt(a.style.left)+45);
    l.setAttribute("y1", parseInt(a.style.top)+45);
    l.setAttribute("x2", parseInt(b.style.left)+45);
    l.setAttribute("y2", parseInt(b.style.top)+45);
    l.setAttribute("stroke","#aaa");
    l.setAttribute("stroke-width","2");
    svg.appendChild(l);
  });
}

function connectNearest(){
  if(!selected) return;
  let min = Infinity, target = null;

  nodes.forEach(n=>{
    if(n === selected) return;
    const d = Math.hypot(
      parseInt(n.style.left)-parseInt(selected.style.left),
      parseInt(n.style.top)-parseInt(selected.style.top)
    );
    if(d < min){ min = d; target = n; }
  });

  if(target){
    connections.push([selected, target]);
    drawLines();
    saveAll();
  }
}

/* ======================
   PANEL INPUTS
====================== */
titleInput.oninput = ()=>{
  if(!selected) return;
  selected.dataset.title = titleInput.value;
  selected.querySelector(".node-title").textContent = titleInput.value;
  saveAll();
};

descInput.oninput = ()=>{
  if(!selected) return;
  selected.dataset.desc = descInput.value;
  saveAll();
};

sizeInput.oninput = ()=>{
  if(!selected) return;
  selected.dataset.size = sizeInput.value;
  selected.style.transform = `scale(${sizeInput.value})`;
  drawLines();
  saveAll();
};

fileInput.onchange = ()=>{
  if(!selected || !fileInput.files[0]) return;
  const r = new FileReader();
  r.onload = e=>{
    selected.dataset.img = e.target.result;
    const b = selected.querySelector(".bubble");
    b.innerHTML = "";
    const img = document.createElement("img");
    img.src = e.target.result;
    b.appendChild(img);
    saveAll();
  };
  r.readAsDataURL(fileInput.files[0]);
};

/* ======================
   BUTTONS
====================== */
btnAdd.onclick = ()=> addBubble();
btnConnect.onclick = connectNearest;

btnClear.onclick = ()=>{
  if(!selected) return;
  connections = connections.filter(c=>c[0]!==selected && c[1]!==selected);
  drawLines();
  saveAll();
};

btnDelete.onclick = ()=>{
  if(!selected) return;
  connections = connections.filter(c=>c[0]!==selected && c[1]!==selected);
  nodes = nodes.filter(n=>n!==selected);
  selected.remove();
  selected = null;
  panel.hidden = true;
  drawLines();
  saveAll();
};

/* ======================
   SAVE / LOAD
====================== */
function saveAll(){
  clearTimeout(saveTimer);

  saveTimer = setTimeout(async ()=>{
    const treeId = document.body.dataset.tree;

    await supabase.from("skill_nodes").upsert(
      nodes.map(n=>({
        id:n.dataset.id,
        tree_id:treeId,
        left_pos:n.style.left,
        top_pos:n.style.top,
        title:n.dataset.title,
        description:n.dataset.desc,
        image:n.dataset.img,
        size:n.dataset.size
      }))
    );

    await supabase
      .from("skill_connections")
      .delete()
      .eq("tree_id", treeId);

    if(connections.length){
      await supabase.from("skill_connections").insert(
        connections.map(c=>({
          tree_id:treeId,
          from_node:c[0].dataset.id,
          to_node:c[1].dataset.id
        }))
      );
    }
  }, 300);
}

async function loadTree(){
  const treeId = document.body.dataset.tree;

  const { data:nodesData } = await supabase
    .from("skill_nodes")
    .select("*")
    .eq("tree_id", treeId);

  nodesData?.forEach(n=>addBubble({
    id:n.id,
    left:n.left_pos,
    top:n.top_pos,
    title:n.title,
    desc:n.description,
    img:n.image,
    size:n.size
  }, true));

  const { data:connData } = await supabase
    .from("skill_connections")
    .select("*")
    .eq("tree_id", treeId);

  connData?.forEach(c=>{
    const a = nodes.find(n=>n.dataset.id===c.from_node);
    const b = nodes.find(n=>n.dataset.id===c.to_node);
    if(a && b) connections.push([a,b]);
  });

  drawLines();
}

loadTree();
</script>

</body>
</html>
